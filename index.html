<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°èªèªè©å…‹æ¼å­—æ¸¬é©—</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Charis+SIL:ital,wght@0,400;0,700;1,400;1,700&family=Noto+Sans+TC:wght@400;700&display=swap');

        body { 
            font-family: 'Charis SIL', 'Noto Sans TC', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            background: #fdf2f8; margin: 0; padding: 20px; 
        }
        #quiz-container { 
            background: white; padding: 30px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(219, 39, 119, 0.1); 
            width: 100%; max-width: 500px; text-align: center; 
        }
        
        .start-btn {
            display: block; width: 100%; padding: 15px; margin-bottom: 15px;
            font-size: 24px; font-weight: bold; background: #fce7f3; color: #9d174d;
            border: 2px solid #fbcfe8; border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .start-btn:hover { background: #fbcfe8; border-color: #db2777; }

        .info-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: bold; }
        #progress { color: #db2777; font-size: 18px; }
        #timer-display { color: #e11d48; font-size: 20px; background: #ffe4e6; padding: 5px 10px; border-radius: 8px; }
        
        .question-box { background: #fce7f3; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .question-text { font-size: 40px; font-weight: bold; color: #9d174d; letter-spacing: 2px; }
        .hint-text { font-size: 24px; color: #831843; margin-top: 15px; line-height: 1.5; min-height: 3em; }
        
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button { font-family: 'Charis SIL', 'Noto Sans TC', sans-serif; }
        .opt-btn { 
            padding: 15px; font-size: 26px; cursor: pointer; 
            border: 2px solid #fbcfe8; border-radius: 8px; background: white; transition: all 0.2s; 
        }
        .opt-btn:hover:not(:disabled) { background: #fdf2f8; border-color: #db2777; color: #db2777; }
        .opt-btn:disabled { cursor: default; }
        
        #score-board { margin-top: 20px; font-size: 22px; font-weight: bold; color: #9d174d; }
        .hidden { display: none; }
        
        .wrong-list-box {
            text-align: left; background: #fff1f2; padding: 15px; 
            border-radius: 8px; margin-top: 15px; margin-bottom: 20px; 
            max-height: 250px; overflow-y: auto; border: 2px solid #fecdd3;
        }
        .wrong-item { border-bottom: 1px dashed #fda4af; padding: 10px 0; }
        .wrong-item:last-child { border-bottom: none; }
        
        .action-btn {
            width: 100%; padding: 15px; font-size: 22px; font-weight:bold; 
            border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; transition: 0.2s;
        }
        .btn-download { background: #f472b6; color: white; }
        .btn-download:hover { background: #db2777; }
        .btn-restart { background: #9d174d; color: white; }
        .btn-restart:hover { background: #831843; }
        
        .feedback-text { font-size: 26px; font-weight: bold; color: #be185d; margin: 15px 0; padding: 10px; background: #fdf2f8; border-radius: 8px; border: 2px dashed #fbcfe8; }
        
        /* æµé‡èˆ‡ç‰ˆæ¬Šå€åŸŸæ¨£å¼ */
        .footer-area { margin-top: 30px; text-align: center; color: #db2777; font-size: 14px; line-height: 1.8; }
    </style>
</head>
<body>

<div id="quiz-container">
    <div id="setup"><h2 style="color: #9d174d;">é¡Œåº«è¼‰å…¥ä¸­...</h2></div>
    
    <div id="start-screen" class="hidden">
        <h2 style="color: #9d174d; font-size: 32px; margin-bottom: 20px;">è«‹é¸æ“‡æ¸¬é©—é¡Œæ•¸</h2>
        <button class="start-btn" onclick="startQuiz(10)">ğŸš€ å¿«é€ŸæŒ‘æˆ° (10 é¡Œ)</button>
        <button class="start-btn" onclick="startQuiz(50)">ğŸ’ª æ—¥å¸¸ç·´ç¿’ (50 é¡Œ)</button>
        <button class="start-btn" onclick="startQuiz(100)">ğŸ† å®Œæ•´æ¨¡æ“¬ (100 é¡Œ)</button>
    </div>

    <div id="quiz-box" class="hidden">
        <div class="info-bar">
            <div id="progress">ç¬¬ 1 é¡Œ</div>
            <div id="timer-display">â³ 10 ç§’</div>
        </div>
        <div class="question-box">
            <div class="question-text" id="question-display"></div>
            <div class="hint-text" id="hint-display">è¼‰å…¥ä¸­...</div>
        </div>
        <div class="options" id="options-container"></div>
        <div id="score-board">ç›®å‰åˆ†æ•¸: 0</div>
    </div>

    <div id="result" class="hidden"></div>
</div>

<div class="footer-area">
    æœ¬ç«™ç¸½ç€è¦½äººæ¬¡ï¼š<span id="busuanzi_value_site_pv">è¼‰å…¥ä¸­</span> æ¬¡<br>
    Copyright &copy; 2026 æ¸¸é›ªå›. All rights reserved.
</div>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script>
// --- âš ï¸ è«‹è¨˜å¾—åœ¨é€™è£¡è²¼ä¸Šä½ çš„ Google Sheets CSV é€£çµ ---
const CSV_URL = 'https://docs.google.com/spreadsheets/d/1_j4wT7D-dkKyHqiQ-Ce-kLo1tuHmmB2MgCDDzFGrTa0/export?format=csv';

let allData = [];
let quizList = [];
let currentIndex = 0;
let score = 0;
let timeLeft = 10;
let timerInterval;
let wrongAnswers = []; 

async function init() {
    try {
        const response = await fetch(CSV_URL);
        const data = await response.text();
        const rows = data.split('\n').slice(1).filter(r => r.trim() !== '');
        
        allData = rows.map(row => {
            const cols = row.split(',');
            return { hanji: cols[0].trim(), phingim: cols[1].trim() };
        });

        document.getElementById('setup').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
    } catch (e) { document.getElementById('setup').innerText = "è¼‰å…¥å¤±æ•—"; console.error(e); }
}

function startQuiz(questionCount) {
    let history = JSON.parse(localStorage.getItem('taigi_quiz_history') || "[]");
    let availablePool = allData.filter(q => !history.includes(q.hanji + q.phingim));

    if (availablePool.length < questionCount) { availablePool = allData; history = []; }

    const shuffled = availablePool.sort(() => 0.5 - Math.random());
    const selected = shuffled.slice(0, questionCount);

    const newHistory = [...history, ...selected.map(q => q.hanji + q.phingim)];
    if (newHistory.length > 500) { newHistory.splice(0, newHistory.length - 500); }
    localStorage.setItem('taigi_quiz_history', JSON.stringify(newHistory));

    const half = Math.ceil(questionCount / 2);
    const part1 = selected.slice(0, half).map(q => ({...q, type: 'H'}));
    const part2 = selected.slice(half, questionCount).map(q => ({...q, type: 'P'}));
    quizList = [...part1, ...part2].sort(() => 0.5 - Math.random());
    
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('quiz-box').classList.remove('hidden');
    renderQuestion();
}

function renderQuestion() {
    if (currentIndex >= quizList.length) { showResult(); return; }
    
    const current = quizList[currentIndex];
    const isHanji = current.type === 'H';
    let parts = isHanji ? current.hanji.split('') : current.phingim.split('-');
    const blankIndex = Math.floor(Math.random() * parts.length);
    const correctAnswer = parts[blankIndex];
    let displayParts = [...parts];
    displayParts[blankIndex] = "ï¼ˆã€€ï¼‰";
    
    document.getElementById('progress').innerText = `ç¬¬ ${currentIndex + 1} / ${quizList.length} é¡Œ`;
    document.getElementById('question-display').innerText = isHanji ? displayParts.join('') : displayParts.join('-');
    document.getElementById('hint-display').innerHTML = isHanji ? `æç¤ºï¼š${current.phingim}` : `æç¤ºï¼š${current.hanji}`;

    let distractors = allData.flatMap(d => isHanji ? d.hanji.split('') : d.phingim.split('-')).filter(i => i !== correctAnswer && i.length > 0);
    let options = [correctAnswer, ...[...new Set(distractors)].sort(() => 0.5 - Math.random()).slice(0, 3)];
    options.sort(() => 0.5 - Math.random());

    const container = document.getElementById('options-container');
    container.innerHTML = '';
    options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'opt-btn';
        btn.innerText = opt;
        btn.onclick = () => checkAnswer(opt, correctAnswer);
        container.appendChild(btn);
    });

    clearInterval(timerInterval);
    timeLeft = 10;
    document.getElementById('timer-display').innerText = `â³ ${timeLeft} ç§’`;
    
    timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer-display').innerText = `â³ ${timeLeft} ç§’`;
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            checkAnswer(null, correctAnswer); 
        }
    }, 1000);
}

function checkAnswer(selected, correct) {
    clearInterval(timerInterval); 
    const current = quizList[currentIndex];
    const buttons = document.getElementById('options-container').getElementsByTagName('button');
    
    for (let btn of buttons) {
        btn.disabled = true;
        if (btn.innerText === correct) { btn.style.background = "#dcfce7"; btn.style.borderColor = "#22c55e"; }
        if (btn.innerText === selected && selected !== correct) { btn.style.background = "#fee2e2"; btn.style.borderColor = "#ef4444"; }
    }
    
    const hintBox = document.getElementById('hint-display');
    if (selected === correct) {
        score++;
        hintBox.innerHTML = `<b style="color: #22c55e;">æ­£ç¢ºï¼</b><br>å®Œæ•´ï¼š${current.hanji} (${current.phingim})`;
    } else {
        const errorReason = selected === null ? "é€¾æ™‚æœªç­”" : "ç­”éŒ¯äº†";
        hintBox.innerHTML = `<b style="color: #ef4444;">${errorReason}...</b><br>æ­£è§£ï¼šã€Œ${correct}ã€<br>å®Œæ•´ï¼š${current.hanji} (${current.phingim})`;
        
        wrongAnswers.push({
            fullHanji: current.hanji,
            fullPhingim: current.phingim,
            userAns: selected === null ? "é€¾æ™‚æœªç­”" : selected,
            correctAns: correct
        });
    }
    document.getElementById('score-board').innerText = `ç›®å‰åˆ†æ•¸: ${score}`;
    setTimeout(() => { currentIndex++; renderQuestion(); }, 2000);
}

function showResult() {
    document.getElementById('quiz-box').classList.add('hidden');
    const resultBox = document.getElementById('result');
    resultBox.classList.remove('hidden');
    
    let ratio = score / quizList.length;
    let feedbackMsg = "";
    
    if (ratio <= 0.2) {
        feedbackMsg = "ç„¡è¦ç·Šï¼Œå’±é–£ä¾†ä¸€éï¼";
    } else if (ratio <= 0.5) {
        feedbackMsg = "è¢‚ä†€å–”ï¼é–£è©¦å¹¾éæœƒæ„ˆä¾†æ„ˆé€²æ­¥å–”ï¼";
    } else if (ratio <= 0.8) {
        feedbackMsg = "èª ğ ¢•å‘¢ï¼é–£è©¦å¹¾éæœƒæ„ˆä¾†æ„ˆå²å®³å–”ï¼";
    } else {
        feedbackMsg = "åŸä¾†é«˜æ‰‹å°±æ˜¯ä½ ï¼ğŸ†";
    }
    
    let html = `<h2 style="color: #9d174d; font-size: 32px; margin-bottom:10px;">æ¸¬é©—å®Œæˆï¼</h2>`;
    html += `<p style="font-size: 24px; color: #831843; font-weight:bold; margin-bottom: 5px;">ä½ çš„å¾—åˆ†ï¼š${score} / ${quizList.length}</p>`;
    html += `<div class="feedback-text">${feedbackMsg}</div>`;
    
    if (wrongAnswers.length > 0) {
        html += `<h3 style="color: #e11d48; text-align:left; margin-bottom:5px;">ğŸ“‹ éŒ¯é¡Œç¸½è¦½ (å…± ${wrongAnswers.length} é¡Œ)ï¼š</h3>`;
        html += `<div class="wrong-list-box">`;
        wrongAnswers.forEach((q, idx) => {
            html += `<div class="wrong-item">
                <div style="font-size: 22px; font-weight: bold; color: #9d174d;">${idx + 1}. ${q.fullHanji}</div>
                <div style="font-size: 20px; color: #db2777; margin-bottom: 5px;">${q.fullPhingim}</div>
                <div style="font-size: 16px; color: #475569;">
                    âŒ ä½ çš„ä½œç­”: <span style="color:#ef4444">${q.userAns}</span> <br>
                    âœ… æ­£ç¢ºç­”æ¡ˆ: <span style="color:#22c55e">${q.correctAns}</span>
                </div>
            </div>`;
        });
        html += `</div>`;
        html += `<button class="action-btn btn-download" onclick="downloadWrongList()">ğŸ“¥ ä¸‹è¼‰éŒ¯é¡Œæœ¬ (.txt)</button>`;
    } else {
        html += `<p style="color: #22c55e; font-size: 20px; font-weight: bold; padding: 20px 0;">å¤ªå²å®³äº†ï¼å…¨å°ï¼æ»¿åˆ†éé—œï¼ğŸ‰</p>`;
    }
    
    html += `<button class="action-btn btn-restart" onclick="location.reload()">ğŸ”„ å›é¦–é é‡æ–°æŒ‘æˆ°</button>`;
    resultBox.innerHTML = html;
}

function downloadWrongList() {
    let content = "===== å°èªå­—éŸ³å­—å½¢æ¸¬é©— - éŒ¯é¡Œæœ¬ =====\n\n";
    content += `æ¸¬é©—å¾—åˆ†ï¼š${score} / ${quizList.length}\n`;
    content += `éŒ¯é¡Œæ•¸é‡ï¼š${wrongAnswers.length} é¡Œ\n`;
    content += "=====================================\n\n";
    
    wrongAnswers.forEach((q, idx) => {
        content += `ç¬¬ ${idx + 1} é¡Œï¼š\n`;
        content += `ã€å®Œæ•´èªè©ã€‘ ${q.fullHanji} (${q.fullPhingim})\n`;
        content += `ã€ä½ çš„ä½œç­”ã€‘ âŒ ${q.userAns}\n`;
        content += `ã€æ­£ç¢ºç­”æ¡ˆã€‘ âœ… ${q.correctAns}\n`;
        content += "-------------------------------------\n";
    });

    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "å°èªéŒ¯é¡Œæœ¬.txt";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

init();
</script>
</body>
</html>
